"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("./handler-4e1500d2.js"),m=require("@aws-sdk/client-s3"),U=require("@aws-sdk/lib-storage"),w=require("react"),C=require("@smithy/fetch-http-handler"),F=require("@aws-sdk/s3-request-presigner");require("@aws-sdk/client-sts");require("uuid");var b=function(r){r===void 0&&(r={});var n=function(a,c){return i.__awaiter(this,void 0,void 0,function(){var u,o;return i.__generator(this,function(d){switch(d.label){case 0:return d.trys.push([0,2,,3]),[4,i.handler({request:a,options:r})];case 1:return u=d.sent(),c.status(200).json(u),[3,3];case 2:return o=d.sent(),console.error(o),c.status(500).json({error:"Internal Server Error"}),[3,3];case 3:return[2]}})})},e=function(a){return b(a)};return Object.assign(n,{configure:e})},S=b(),R=w.forwardRef(function(r,n){var e=r.onChange,a=e===void 0?function(){}:e,c=i.__rest(r,["onChange"]),u=function(o){var d,t,l=(t=(d=o.target)===null||d===void 0?void 0:d.files)===null||t===void 0?void 0:t[0];a(l,o)};return w.createElement("input",i.__assign({onChange:u},c,{ref:n,type:"file"}))}),I=function(){var r=w.useRef(),n=w.useState([]),e=n[0],a=n[1],c=function(){var t;r.current&&(r.current.value="",(t=r.current)===null||t===void 0||t.click())},u=function(){a([])},o=function(t,l){a(function(f){return f.map(function(s){return s.file===t?{file:t,uploaded:l,id:s.id,size:t.size,progress:t.size?l/t.size*100:0}:s})})},d=function(t){a(function(l){return i.__spreadArray(i.__spreadArray([],l,!0),[{file:t,progress:0,uploaded:0,size:t.size,id:i.uuid()}],!1)})};return{FileInput:function(t){return w.createElement(R,i.__assign({},t,{ref:r,style:{display:"none"}}))},openFileDialog:c,files:e,addFile:d,updateFileProgress:o,resetFiles:u}},k=function(r,n,e){var a=I(),c=a.addFile,u=a.updateFileProgress,o=a.FileInput,d=a.openFileDialog,t=a.files,l=a.resetFiles,f=function(s,g){return g===void 0&&(g={}),i.__awaiter(void 0,void 0,void 0,function(){var p,v,h;return i.__generator(this,function(y){switch(y.label){case 0:return e!=null&&e.endpoint&&(process.env.NODE_ENV==="development"&&console.warn("[Next S3 Upload] The `endpoint` option has been replaced by `endpoint.request.url`. For more information see: https://next-s3-upload.codingvalue.com/changes/endpoint"),g.endpoint?g.endpoint.request.url=e.endpoint:g.endpoint={request:{url:e.endpoint}}),[4,T(r,s,(h=g.endpoint)===null||h===void 0?void 0:h.request)];case 1:if(p=y.sent(),p.error)throw console.error(p.error),p.error;return c(s),[4,n(s,p,{onProgress:function(_){return u(s,_)}})];case 2:return v=y.sent(),[2,v]}})})};return{FileInput:o,openFileDialog:d,uploadToS3:f,files:t,resetFiles:l}},T=function(r,n,e){return i.__awaiter(void 0,void 0,void 0,function(){var a,c,u,o,d,t,l,f,s;return i.__generator(this,function(g){switch(g.label){case 0:return a=(l=e==null?void 0:e.body)!==null&&l!==void 0?l:{},c=(f=e==null?void 0:e.headers)!==null&&f!==void 0?f:{},u=(s=e==null?void 0:e.url)!==null&&s!==void 0?s:"/api/s3-upload",o=i.__assign({filename:n.name,filetype:n.type,_nextS3:{strategy:r}},a),d=i.__assign(i.__assign({},c),{"Content-Type":"application/json"}),[4,fetch(u,{method:"POST",headers:d,body:JSON.stringify(o)})];case 1:return t=g.sent(),[4,t.json()];case 2:return[2,g.sent()]}})})},K=function(r,n,e){var a=e.onProgress;return i.__awaiter(void 0,void 0,void 0,function(){var c,u,o,d,t,l,f,s,g,p,v;return i.__generator(this,function(h){switch(h.label){case 0:return c=n.key,u=n.bucket,o=n.token,d=n.region,t=new m.S3Client({requestHandler:new C.FetchHttpHandler({keepAlive:!1}),credentials:{accessKeyId:o.Credentials.AccessKeyId,secretAccessKey:o.Credentials.SecretAccessKey,sessionToken:o.Credentials.SessionToken},region:d}),l={Bucket:u,Key:c,Body:r,CacheControl:"max-age=630720000, public",ContentType:r.type},f=new U.Upload({client:t,params:l}),f.on("httpUploadProgress",function(y){var _,P=(_=y.loaded)!==null&&_!==void 0?_:0;a(P)}),[4,f.done()];case 1:return s=h.sent(),g=s.Bucket&&s.Key?"https://".concat(s.Bucket,".s3.").concat(d,".amazonaws.com/").concat(s.Key):"",[2,{url:g,bucket:(p=s.Bucket)!==null&&p!==void 0?p:"",key:(v=s.Key)!==null&&v!==void 0?v:""}]}})})},q=function(r){var n=k("aws-sdk",K,r);return n},z=function(r,n,e){var a=e.onProgress;return i.__awaiter(void 0,void 0,void 0,function(){var c,u,o,d,t,l,f;return i.__generator(this,function(s){switch(s.label){case 0:return c=n.url,u=n.key,o=n.bucket,d=n.region,t=n.endpoint,[4,r.arrayBuffer()];case 1:return l=s.sent(),[4,new Promise(function(g,p){var v=new XMLHttpRequest;v.upload.onprogress=function(h){a(h.loaded)},v.open("PUT",c,!0),v.setRequestHeader("Content-Type",r.type),v.setRequestHeader("Cache-Control","max-age=630720000"),v.onreadystatechange=function(){v.readyState===4&&(v.status>=200&&v.status<300?g():p())},v.send(l)})];case 2:return s.sent(),f=t?"".concat(t,"/").concat(o,"/").concat(u):"https://".concat(o,".s3.").concat(d,".amazonaws.com/").concat(u),[2,{url:f,bucket:o,key:u}]}})})},H=function(){var r=k("presigned",z);return r},j=function(r){return new Promise(function(n){var e;if(((e=r.type.split("/"))===null||e===void 0?void 0:e[0])==="image"){var a=new Image,c=URL.createObjectURL(r);a.onload=function(u){var o=u.target;n({height:o.height,width:o.width}),URL.revokeObjectURL(c)},a.src=c}else n({height:void 0,width:void 0})})},x=function(r,n){return i.__awaiter(void 0,void 0,void 0,function(){var e,a,c,u;return i.__generator(this,function(o){switch(o.label){case 0:return e=i.getConfig(n),a=i.getClient(n),c=new m.GetObjectCommand({Bucket:e.bucket,Key:r}),[4,F.getSignedUrl(a,c,{expiresIn:3600})];case 1:return u=o.sent(),[2,u]}})})};exports.sanitizeKey=i.sanitizeKey;exports.uuid=i.uuid;exports.APIRoute=S;exports.generateTemporaryUrl=x;exports.getImageData=j;exports.usePresignedUpload=H;exports.useS3Upload=q;
