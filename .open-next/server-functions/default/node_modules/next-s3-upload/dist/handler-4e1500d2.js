"use strict";const k=require("@aws-sdk/client-sts"),E=require("@aws-sdk/client-s3"),U=require("@aws-sdk/s3-request-presigner"),q=require("uuid");exports.__assign=function(){return exports.__assign=Object.assign||function(s){for(var t,c=1,a=arguments.length;c<a;c++){t=arguments[c];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},exports.__assign.apply(this,arguments)};function R(n,s){var t={};for(var c in n)Object.prototype.hasOwnProperty.call(n,c)&&s.indexOf(c)<0&&(t[c]=n[c]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,c=Object.getOwnPropertySymbols(n);a<c.length;a++)s.indexOf(c[a])<0&&Object.prototype.propertyIsEnumerable.call(n,c[a])&&(t[c[a]]=n[c[a]]);return t}function P(n,s,t,c){function a(e){return e instanceof t?e:new t(function(i){i(e)})}return new(t||(t=Promise))(function(e,i){function u(o){try{r(c.next(o))}catch(y){i(y)}}function l(o){try{r(c.throw(o))}catch(y){i(y)}}function r(o){o.done?e(o.value):a(o.value).then(u,l)}r((c=c.apply(n,s||[])).next())})}function x(n,s){var t={label:0,sent:function(){if(e[0]&1)throw e[1];return e[1]},trys:[],ops:[]},c,a,e,i;return i={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function u(r){return function(o){return l([r,o])}}function l(r){if(c)throw new TypeError("Generator is already executing.");for(;i&&(i=0,r[0]&&(t=0)),t;)try{if(c=1,a&&(e=r[0]&2?a.return:r[0]?a.throw||((e=a.return)&&e.call(a),0):a.next)&&!(e=e.call(a,r[1])).done)return e;switch(a=0,e&&(r=[r[0]&2,e.value]),r[0]){case 0:case 1:e=r;break;case 4:return t.label++,{value:r[1],done:!1};case 5:t.label++,a=r[1],r=[0];continue;case 7:r=t.ops.pop(),t.trys.pop();continue;default:if(e=t.trys,!(e=e.length>0&&e[e.length-1])&&(r[0]===6||r[0]===2)){t=0;continue}if(r[0]===3&&(!e||r[1]>e[0]&&r[1]<e[3])){t.label=r[1];break}if(r[0]===6&&t.label<e[1]){t.label=e[1],e=r;break}if(e&&t.label<e[2]){t.label=e[2],t.ops.push(r);break}e[2]&&t.ops.pop(),t.trys.pop();continue}r=s.call(n,t)}catch(o){r=[6,o],a=0}finally{c=e=0}if(r[0]&5)throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}}function D(n,s,t){if(t||arguments.length===2)for(var c=0,a=s.length,e;c<a;c++)(e||!(c in s))&&(e||(e=Array.prototype.slice.call(s,0,c)),e[c]=s[c]);return n.concat(e||Array.prototype.slice.call(s))}function p(n){var s,t,c,a;return{accessKeyId:(s=n==null?void 0:n.accessKeyId)!==null&&s!==void 0?s:"".concat(process.env.S3_UPLOAD_KEY),secretAccessKey:(t=n==null?void 0:n.secretAccessKey)!==null&&t!==void 0?t:"".concat(process.env.S3_UPLOAD_SECRET),bucket:(c=n==null?void 0:n.bucket)!==null&&c!==void 0?c:"".concat(process.env.S3_UPLOAD_BUCKET),region:(a=n==null?void 0:n.region)!==null&&a!==void 0?a:"".concat(process.env.S3_UPLOAD_REGION),endpoint:n==null?void 0:n.endpoint,forcePathStyle:n==null?void 0:n.forcePathStyle}}function j(n){var s=p(n),t=new E.S3Client(exports.__assign(exports.__assign({credentials:{accessKeyId:s.accessKeyId,secretAccessKey:s.secretAccessKey},region:s.region},s.forcePathStyle?{forcePathStyle:s.forcePathStyle}:{}),s.endpoint?{endpoint:s.endpoint}:{}));return t}var I=function(){return q.v4()},N=/[^0-9a-zA-Z!_\\.\\*'\\(\\)\\\-/]/g,T=function(n){return n.replace(N," ").replace(/\s+/g,"-")};function L(n){var s,t=n.request,c=n.options;return P(this,void 0,void 0,function(){var a,e,i,u,l,r,o,y,f,v,_,b,h,S,g,w,m,A,O,K;return x(this,function(d){switch(d.label){case 0:if(a=p(c),e=z(a),e.length>0)throw new Error("Next S3 Upload: Missing ENVs ".concat(e.join(", ")));return t.json?[4,t.json()]:[3,2];case 1:return u=d.sent(),[3,3];case 2:u=t.body,d.label=3;case 3:return i=u,l=i.filename,c.key?[4,Promise.resolve(c.key(t,l))]:[3,5];case 4:return o=d.sent(),[3,6];case 5:o="next-s3-uploads/".concat(I(),"/").concat(T(l)),d.label=6;case 6:return r=o,y=(s=i._nextS3)===null||s===void 0?void 0:s.strategy,f=a.bucket,v=a.region,_=a.endpoint,y!=="presigned"?[3,8]:(b=i.filetype,h=j(a),S={Bucket:f,Key:r,ContentType:b,CacheControl:"max-age=630720000"},[4,U.getSignedUrl(h,new E.PutObjectCommand(S),{expiresIn:60*60})]);case 7:return g=d.sent(),[2,{key:r,bucket:f,region:v,endpoint:_,url:g}];case 8:return w={credentials:{accessKeyId:a.accessKeyId,secretAccessKey:a.secretAccessKey},region:v},m={Statement:[{Sid:"Stmt1S3UploadAssets",Effect:"Allow",Action:["s3:PutObject"],Resource:["arn:aws:s3:::".concat(f,"/").concat(r)]}]},A=new k.STSClient(w),O=new k.GetFederationTokenCommand({Name:"S3UploadWebToken",Policy:JSON.stringify(m),DurationSeconds:60*60}),[4,A.send(O)];case 9:return K=d.sent(),[2,{token:K,key:r,bucket:f,region:v}]}})})}var z=function(n){var s=["accessKeyId","secretAccessKey","bucket","region"];return s.filter(function(t){return!n[t]||n.key===""})};exports.__awaiter=P;exports.__generator=x;exports.__rest=R;exports.__spreadArray=D;exports.getClient=j;exports.getConfig=p;exports.handler=L;exports.sanitizeKey=T;exports.uuid=I;
