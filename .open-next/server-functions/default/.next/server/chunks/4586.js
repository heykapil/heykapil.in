"use strict";exports.id=4586,exports.ids=[4586],exports.modules={68882:(e,t,a)=>{a.d(t,{Cz:()=>l,EM:()=>i,Fb:()=>r,RD:()=>m,VG:()=>c,aX:()=>d,m3:()=>u,nP:()=>o,nV:()=>n}),a(65888);var s=a(8412),n=(0,s.$)("1e0322ba455c4fa7df31cdd42ecfc9179872ae4b"),o=(0,s.$)("a6dd94c9a5ee4e261e28e05bb5ec9f9fd212030d"),i=(0,s.$)("7f1c634e496dd895dea4360bfcb9158f1df525e7"),r=(0,s.$)("fcb5f23b294268d5e3519c39d7e93eea08dcdcc9"),c=(0,s.$)("c32985692d7ea9b3172c844b20d509274c70b8da");(0,s.$)("70e8978391a906d6eea06d651a38ae32ad637af2");var l=(0,s.$)("066c11b8cac3d53459fd0307a3b3cc47ced190a1"),u=(0,s.$)("974b965e2f2ef6bef20f0297f5dbd1e717f12dbd"),d=(0,s.$)("a7f4b3fb4d4625bcd3ded760593d943407b107c0"),m=(0,s.$)("050ef9f29dc3971027a64713c2e31c4cdb093526");(0,s.$)("e30178d742d3d980882e44bab85fc6bec80de55d"),(0,s.$)("caf39b3519f53738dbd77e195302de8d39014d5e"),(0,s.$)("c2ff7206db9feb41c1f1c0b0aec74d177cb5a725"),(0,s.$)("638b5c86cdc66022f2483d06195290321560aa51")},37770:(e,t,a)=>{let s;a.r(t),a.d(t,{ChangePass:()=>W,ForgotPass:()=>Z,Login:()=>M,Logout:()=>Q,OauthCallback:()=>ea,OauthLogin:()=>et,Register:()=>X,ResetPassword:()=>ee,deleteGuestbookEntries:()=>Y,increment:()=>K,saveGuestbookEntry:()=>q,saveUploadHistory:()=>F,saveVisitorLog:()=>G,sendEmail:()=>H});var n=a(81674);a(47770);var o=a(37175),i=a(89194),r=a(518),c=a(86656);let l=[{name:"views",columns:[{name:"count",type:"int",notNull:!0,defaultValue:"0"},{name:"slug",type:"string",unique:!0}]},{name:"guestbook",columns:[{name:"email",type:"string",notNull:!0,defaultValue:"user@example.com"},{name:"body",type:"string",notNull:!0,defaultValue:"Lorem ipsum dolor sit amet, consectetur adip"},{name:"created_by",type:"string",notNull:!0,defaultValue:"User Name"},{name:"image",type:"string",notNull:!0,defaultValue:"https://cdn.kapil.app"},{name:"created_at",type:"datetime",notNull:!0,defaultValue:"now"},{name:"updated_at",type:"datetime",notNull:!0,defaultValue:"now"}]},{name:"redirects",columns:[{name:"source",type:"string"},{name:"destination",type:"string",notNull:!0,defaultValue:"https://cdn.kapil.app"},{name:"permanent",type:"bool",notNull:!0,defaultValue:"false"}]},{name:"nextauth_users",columns:[{name:"email",type:"email"},{name:"emailVerified",type:"datetime"},{name:"name",type:"string"},{name:"image",type:"string"}],revLinks:[{column:"user",table:"nextauth_accounts"},{column:"user",table:"nextauth_users_accounts"},{column:"user",table:"nextauth_users_sessions"},{column:"user",table:"nextauth_sessions"}]},{name:"nextauth_accounts",columns:[{name:"user",type:"link",link:{table:"nextauth_users"}},{name:"type",type:"string"},{name:"provider",type:"string"},{name:"providerAccountId",type:"string"},{name:"refresh_token",type:"string"},{name:"access_token",type:"string"},{name:"expires_at",type:"int"},{name:"token_type",type:"string"},{name:"scope",type:"string"},{name:"id_token",type:"text"},{name:"session_state",type:"string"}],revLinks:[{column:"account",table:"nextauth_users_accounts"}]},{name:"nextauth_verificationTokens",columns:[{name:"identifier",type:"string"},{name:"token",type:"string"},{name:"expires",type:"datetime"}]},{name:"nextauth_users_accounts",columns:[{name:"user",type:"link",link:{table:"nextauth_users"}},{name:"account",type:"link",link:{table:"nextauth_accounts"}}]},{name:"nextauth_users_sessions",columns:[{name:"user",type:"link",link:{table:"nextauth_users"}},{name:"session",type:"link",link:{table:"nextauth_sessions"}}]},{name:"nextauth_sessions",columns:[{name:"sessionToken",type:"string"},{name:"expires",type:"datetime"},{name:"user",type:"link",link:{table:"nextauth_users"}}],revLinks:[{column:"session",table:"nextauth_users_sessions"}]},{name:"images_rows",columns:[{name:"created_at",type:"datetime"},{name:"href",type:"string"},{name:"username",type:"string"},{name:"imageSrc",type:"string"},{name:"name",type:"string"}]},{name:"uploads",columns:[{name:"name",type:"string",notNull:!0,defaultValue:"Name"},{name:"url",type:"string",notNull:!0,defaultValue:"https://cdn.kapil.app"},{name:"uploaded_at",type:"text",notNull:!0,defaultValue:"now"},{name:"size",type:"int"}]},{name:"visitors",columns:[{name:"url",type:"string"},{name:"ip",type:"string",notNull:!0,defaultValue:"0.0.0.0"},{name:"location",type:"text",notNull:!0,defaultValue:"Earth"}]}],u=(0,c.kHw)(),d={databaseURL:"https://Kapil-Chaudhary-s-workspace-kmmi3f.ap-southeast-2.xata.sh/db/kapil"};class m extends u{constructor(e){super({...d,...e},l)}}let p=s||(s=new m),g=new i.$2({dialect:new r.pe({xata:p})});var f=a(6113),k=a.n(f),y=a(36130),h=a(9300);let w=process.env.PASETO_SECRET_KEY,b=process.env.PASETO_PUBLIC_KEY,v=process.env.PASETO_LOCAL_KEY,x={expiresIn:"1 day"};async function _({payload:e,key:t,options:a}){try{return(await h.V4.sign(e,t||w,a||x)).slice(10)}catch(e){return console.log(e),null}}async function S({token:e,key:t}){try{let a=await h.V4.verify("v4.public."+e,t||b);return JSON.parse(JSON.stringify(a))}catch(e){return console.log(e),null}}async function T(e,t){try{return(await h.V3.encrypt(e,v,t||x)).slice(9)}catch(e){return console.log(e),null}}async function O(e){try{let t=await h.V3.decrypt("v3.local."+e,v);return JSON.parse(JSON.stringify(t))}catch(e){return console.log(e),null}}var P=a(20770),j=a.n(P);let E=process.env.REDIS_URL;async function $(){return new(j())(E)}var I=a(47013);async function D(){let e;let t=y.cookies().get("profileToken")?.value||"",a=y.cookies().get("sessionId")?.value||"",s=y.cookies().get("accessToken")?.value||"",n=y.cookies().get("refreshToken")?.value||"";if(a&&s&&n&&t||(e=null),!t||a&&s&&n||(e=null),t){let s=await O(t),n=await $(),o=await n.get(s?.userid);console.log(o),o===a?e=s:(e=null,(0,I.redirect)("/signout?error=Session Expired")),await n.quit()}else e=null;return e}var C=a(27580);let L=C.z.object({userid:C.z.string().min(1).max(50),email:C.z.string().email(),fullname:C.z.string().min(1).max(50),avatar:C.z.string().url(),message:C.z.string().min(1).max(500)}),N=C.z.object({username:C.z.string().min(3).max(50),password:C.z.string().min(8).max(50)}),R=C.z.object({email:C.z.string().email(),username:C.z.string().min(3).max(50),password:C.z.string().min(8).max(50),fullname:C.z.string().min(1).max(50)});function A(e){let t="abcdefghijklmnopqrstuvwxyz",a=`1234567890${t}${t.toUpperCase()}`.split(""),s=new Uint8Array(e||8);return k().getRandomValues(s),s.reduce((e,t)=>`${e}${a[61&t]}`,"")}function U(){return"state_"+k().createHash("md5").update(new Date().valueOf().toString(16)).digest("hex")+[...A(8)].sort(()=>Math.random()-.5).join("")}Date.now();let z=e=>e instanceof C.jm?{status:"ERROR",message:"",fieldErrors:e.flatten().fieldErrors,timestamp:Date.now()}:e instanceof Error?{status:"ERROR",message:e.message,fieldErrors:{},timestamp:Date.now()}:{status:"ERROR",message:"An unknown error occurred",fieldErrors:{},timestamp:Date.now()},V=(e,t)=>({status:e,message:t,fieldErrors:{},timestamp:Date.now()});var J=a(47937);let B={httpOnly:!0,sameSite:!0,secure:!0};async function K(e){let t=U(),a=await _({payload:{state:t}}),s=`https://kv.kapil.app/kv/sum?key=pageviews,${e}&value=1&state=${t}`,n=await fetch(s,{method:"POST",headers:{Authorization:`Bearer v4.public.${a}`},body:JSON.stringify(10)});await n.json();let i="/"+e.replace(",","/");(0,o.revalidatePath)(i)}async function q(e){let t=await D();if(!t.email)return z("Error! You must be logged in to post a message.");let a=(e.get("entry")?.toString()||"").slice(0,500);try{let e=U(),s=await T({state:e}),n=process.env.API_URL+"/api/guestbook/submit?"+`state=${e}`,o=L.parse({userid:t?.userid||t?.username,email:t?.email,fullname:t?.fullname||t?.full_name||t?.username,avatar:t?.avatar||`https://ui-avatars.com/api/?background=random&name=${t?.fullname}`||`https://ui-avatars.com/api/?background=random&name=${t?.username}`,message:a}),i=await fetch(n,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}});await i.json()}catch(e){return z(e)}return(0,o.revalidatePath)("/guestbook"),V("SUCCESS","message created")}async function Y(e){let t=await D();if("admin"!==t?.role)throw Error("Unauthorized");let a=U(),s=await T({state:a}),n=await fetch(process.env.API_URL+"/api/guestbook/delete?"+`state=${a}`,{method:"POST",body:JSON.stringify({ids:e}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}}),i=await n.json();if(!i.ok)throw Error(i.error);(0,o.revalidatePath)("/admin"),(0,o.revalidatePath)("/guestbook")}async function F(e){let t=await D(),a=(0,f.randomUUID)(),s=e.get("filename"),n=e.get("fileurl"),i=e.get("filesize"),r=e.get("uploaded_at");if("admin"!==t.role)throw Error("Unauthorized");await g.insertInto("uploads").values({id:a,name:s,size:i,url:n,uploaded_at:r}).execute(),(0,o.revalidatePath)("/upload")}async function G({ip:e,location:t,path:a}){let s=(0,f.randomUUID)();await g.insertInto("visitors").values({id:s,url:a,ip:e,location:t}).execute()}async function H(e){let t;let a=e.get("from")||"Kapil Chaudhary <hi@kapil.app>",s=e.get("to"),n=e.get("subject"),o=e.get("html"),i=e.get("fileurl")||null,r=e.get("filename")||null;t=r&&i?JSON.stringify({from:a,to:s,subject:n,html:o,fileurl:i,filename:r}):JSON.stringify({from:a,to:s,subject:n,html:o});try{let e=await T({subject:n},{expiresIn:"60s"}),a=await fetch("https://api.kapil.app/api/sendEmail",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:t,cache:"no-store"}),s=await a.json();s.message&&(0,y.cookies)().set({name:"email-sent-toast-msg",value:s.message,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e.message)}}async function M(e,t){try{let e=U();(0,y.cookies)().set("state",e,{...B,expires:new Date(Date.now()+6e4)});let a=await T({state:e},{expiresIn:"60s"}),s=N.parse({username:t.get("username"),password:t.get("password")}),n=await fetch(process.env.API_URL+"/api/user/login?"+`state=${e}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":a,"x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value},body:JSON.stringify(s)}),o=await n.json();if(o.ok){let t=n.headers.get("x-state"),a=(await O(t))?.state,s=(await S({token:o.token.access_token}))?.id;if(a===e){let e=function(){let e=Date.now().valueOf().toString(16);return"id_"+e+A(6)}(),t=await fetch(process.env.API_URL+"/api/session",{method:"POST",body:JSON.stringify({sessionid:e,usertype:"Credentials",id:s}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.token.access_token}`,"x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value}});await t.json();let a=await $();await a.set(s,e,"EX",604800),await a.quit(),(0,y.cookies)().set({name:"sessionId",value:e,...B,expires:new Date(o.token.refresh_expiry)}),(0,y.cookies)().set({name:"accessToken",value:o.token.access_token,...B,expires:new Date(o.token.access_expiry)}),(0,y.cookies)().set({name:"refreshToken",value:o.token.refresh_token,...B,expires:new Date(o.token.refresh_expiry)}),(0,y.cookies)().set({name:"profileToken",value:o.token.profile_token,...B,expires:new Date(o.token.profile_expiry)}),(0,y.cookies)().set({name:"LoginCookie",value:"Success",...B,expires:new Date(Date.now()+1e4)}),(0,y.cookies)().delete("state")}return V("SUCCESS","Login successfully!")}return console.log(o),V("ERROR",o.error)}catch(e){return z(e)}}async function X(e,t){let a=R.parse({username:t.get("username")?.toString(),password:t.get("password")?.toString(),email:t.get("email")?.toString(),fullname:t.get("full_name")?.toString()}),s=U();(0,y.cookies)().set("state",s,{...B,expires:new Date(Date.now()+6e4)});let n=`https://ui-avatars.com/api/?background=random&name=${a.fullname}`;try{let e=await T({state:s},{expiresIn:"60s"}),t=await fetch(process.env.API_URL+"/api/user/register?"+`state=${s}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":e,"x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value},body:JSON.stringify({...a,avatar:n,role:"user"})}),o=await t.json();(0,y.cookies)().set({name:"RegisterCookie",value:o.message||o.error||"Something went wrong!",...B,expires:new Date(Date.now()+1e4)})}catch(e){return z(e)}return V("SUCCESS","Registration successful!")}async function Q({callback:e}){return(0,y.cookies)().delete("refreshToken"),(0,y.cookies)().delete("profileToken"),(0,y.cookies)().delete("accessToken"),(0,y.cookies)().delete("sessionId"),(0,y.cookies)().delete("state"),(0,y.cookies)().delete("csrfToken"),(0,I.redirect)(e||"/signin?success=succesfully logged out!"),V("SUCCESS","Logout successful!")}async function W(e){let t=e.get("oldPass")?.toString(),a=e.get("newPass")?.toString(),s=y.cookies()?.get("accessToken")?.value||"",n=(await S({token:s}))?.id||"";try{let e=U();(0,y.cookies)().set("state",e,{httpOnly:!0,secure:!0,expires:new Date(Date.now()+6e4)});let o=await T({state:e},{expiresIn:"60s"}),i=await fetch(process.env.API_URL+"/api/user/password/change"+`?state=${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,Accept:"application/json","x-state":o,"x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value},body:JSON.stringify({id:n,oldPassword:t,newPassword:a})}),r=await i.json();console.log(r),(0,y.cookies)().set({name:"ChangePassCookie",value:r.message||r.error||"Something went wrong!",...B,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e)}}async function Z(e){let t=e.get("username")?.toString();try{let e=U();(0,y.cookies)().set("state",e,{...B,expires:new Date(Date.now()+6e4)});let a=await T({state:e},{expiresIn:"60s"}),s=await fetch(process.env.API_URL+"/api/user/password/recovery"+`?state=${e}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":a,"x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value},body:JSON.stringify({email:t})}),n=await s.json();(0,y.cookies)().set({name:"ForgotPassCookie",value:n.message||n.error||"Something went wrong!",httpOnly:!0,secure:!0,expires:new Date(Date.now()+1e4)})}catch(e){throw console.log(e),Error(e)}}async function ee(e){let t=e.get("password")?.toString(),a=e.get("token")?.toString();try{let e=await fetch(process.env.API_URL+`/api/user/password/reset?token=${a}`,{method:"POST",headers:{"Content-Type":"application/json","x-user-agent":y.cookies().get("userAgent")?.value,"x-ipaddress":y.cookies().get("sessionIP")?.value,"x-location":y.cookies().get("sessionLocation")?.value},body:JSON.stringify({password:t})}),s=await e.json();(0,y.cookies)().set({name:"ResetPassCookie",value:s.message||s.error||"Something went wrong!",httpOnly:!0,secure:!0,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e)}}async function et(e){let t=e.get("callback")?.toString()||"/profile",a=e.get("link")?.toString()||"";if(!a)throw Error("Invalid Link");let s=y.cookies().get("userAgent")?.value||"",n=y.cookies().get("sessionIP")?.value||"",o=y.cookies().get("sessionLocation")?.value||"",i=U();try{(0,y.cookies)().set({name:"csrfToken",value:i,httpOnly:!0,secure:!0,sameSite:!0,expires:new Date(Date.now()+9e4)})}catch(e){throw Error(e)}let r=await T({csrfToken:i,callBackUrl:t,userAgent:s,sessionIP:n,sessionLocation:o},{expiresIn:"60s"}),c=`${a}&state=${r}`;(0,I.redirect)(c)}async function ea({token:e,sessionId:t,next:a}){e&&t||await Q({callback:`/signin?error=invalid_token_or_session_id&callbackUrl=${a}`});let s=await S({token:e}),n=y.cookies().get("csrfToken")?.value||"";s.csrfToken===n&&s.csrfToken&&n||await Q({callback:`/signin?error=error_csrf_token&callbackUrl=${a}`});let o={id:s.id,oauth:s.oauth,oauth_id:s.oauth_id},i=await _({payload:o,options:{expiresIn:"7d"}}),r=await _({payload:o,options:{expiresIn:"7d"}}),c={username:s.username,email:s.email,full_name:s.name,avatar:s.avatar,role:s.oauth+"user",verified:"true",oauth:s.oauth,userid:s.id},l=await T(c,{expiresIn:"7d"}),u={httpOnly:!0,secure:!0,sameSite:!0,expiresIn:60674e4};(0,y.cookies)().set({name:"accessToken",value:i,...u}),(0,y.cookies)().set({name:"refreshToken",value:r,...u}),(0,y.cookies)().set({name:"profileToken",value:l,...u}),(0,y.cookies)().set({name:"sessionId",value:t,...u}),(0,y.cookies)().delete("csrfToken"),(0,I.redirect)(a)}(0,J.h)([K,q,Y,F,G,H,M,X,Q,W,Z,ee,et,ea]),(0,n.j)("a6dd94c9a5ee4e261e28e05bb5ec9f9fd212030d",K),(0,n.j)("7f1c634e496dd895dea4360bfcb9158f1df525e7",q),(0,n.j)("fcb5f23b294268d5e3519c39d7e93eea08dcdcc9",Y),(0,n.j)("c32985692d7ea9b3172c844b20d509274c70b8da",F),(0,n.j)("70e8978391a906d6eea06d651a38ae32ad637af2",G),(0,n.j)("066c11b8cac3d53459fd0307a3b3cc47ced190a1",H),(0,n.j)("974b965e2f2ef6bef20f0297f5dbd1e717f12dbd",M),(0,n.j)("a7f4b3fb4d4625bcd3ded760593d943407b107c0",X),(0,n.j)("050ef9f29dc3971027a64713c2e31c4cdb093526",Q),(0,n.j)("e30178d742d3d980882e44bab85fc6bec80de55d",W),(0,n.j)("caf39b3519f53738dbd77e195302de8d39014d5e",Z),(0,n.j)("c2ff7206db9feb41c1f1c0b0aec74d177cb5a725",ee),(0,n.j)("638b5c86cdc66022f2483d06195290321560aa51",et),(0,n.j)("1e0322ba455c4fa7df31cdd42ecfc9179872ae4b",ea)}};