"use strict";exports.id=4568,exports.ids=[4568],exports.modules={74568:(e,t,a)=>{a.r(t),a.d(t,{ChangePass:()=>$,ForgotPass:()=>C,Login:()=>I,Logout:()=>E,OauthCallback:()=>A,OauthLogin:()=>R,Register:()=>_,ResetPassword:()=>z,deleteGuestbookEntries:()=>P,increment:()=>S,saveGuestbookEntry:()=>j,saveUploadHistory:()=>T,saveVisitorLog:()=>D,sendEmail:()=>O});var s=a(32832);a(9440);var o=a(17460),n=a(55743),i=a(6113),r=a.n(i),c=a(43150),l=a(41119),u=a(69319),d=a(11535),g=a(53564);let p=g.z.object({userid:g.z.string().min(1).max(50),email:g.z.string().email(),fullname:g.z.string().min(1).max(50),avatar:g.z.string().url(),message:g.z.string().min(1).max(500)}),m=g.z.object({username:g.z.string().min(3).max(50),password:g.z.string().min(8).max(50)}),f=g.z.object({email:g.z.string().email(),username:g.z.string().min(3).max(50),password:g.z.string().min(8).max(50),fullname:g.z.string().min(1).max(50)});var k=a(78177);function w(e){let t="abcdefghijklmnopqrstuvwxyz",a=`1234567890${t}${t.toUpperCase()}`.split(""),s=new Uint8Array(e||8);return r().getRandomValues(s),s.reduce((e,t)=>`${e}${a[61&t]}`,"")}function h(){return"state_"+r().createHash("md5").update(new Date().valueOf().toString(16)).digest("hex")+[...w(8)].sort(()=>Math.random()-.5).join("")}Date.now();let v=e=>e instanceof g.jm?{status:"ERROR",message:"",fieldErrors:e.flatten().fieldErrors,timestamp:Date.now()}:e instanceof Error?{status:"ERROR",message:e.message,fieldErrors:{},timestamp:Date.now()}:{status:"ERROR",message:"An unknown error occurred",fieldErrors:{},timestamp:Date.now()},y=(e,t)=>({status:e,message:t,fieldErrors:{},timestamp:Date.now()});var x=a(43385);let b={httpOnly:!0,sameSite:!0,secure:!0};async function S(e){let t=h(),a=await (0,k.YB)({payload:{state:t}}),s=`https://kv.kapil.app/kv/sum?key=pageviews,${e}&value=1&state=${t}`,n=await fetch(s,{method:"POST",headers:{Authorization:`Bearer v4.public.${a}`},body:JSON.stringify(10)});await n.json();let i="/"+e.replace(",","/");(0,o.revalidatePath)(i)}async function j(e){let t=await (0,l.z)();if(!t.email)return v("Error! You must be logged in to post a message.");let a=(e.get("entry")?.toString()||"").slice(0,500);try{let e=h(),s=await (0,k.n0)({state:e}),o=process.env.API_URL+"/api/guestbook/submit?"+`state=${e}`,n=p.parse({userid:t?.userid||t?.username,email:t?.email,fullname:t?.fullname||t?.full_name||t?.username,avatar:t?.avatar||`https://ui-avatars.com/api/?background=random&name=${t?.fullname}`||`https://ui-avatars.com/api/?background=random&name=${t?.username}`,message:a}),i=await fetch(o,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}});await i.json()}catch(e){return v(e)}return(0,o.revalidatePath)("/guestbook"),y("SUCCESS","message created")}async function P(e){let t=await (0,l.z)();if("admin"!==t?.role)throw Error("Unauthorized");let a=h(),s=await (0,k.n0)({state:a}),n=await fetch(process.env.API_URL+"/api/guestbook/delete?"+`state=${a}`,{method:"POST",body:JSON.stringify({ids:e}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}}),i=await n.json();if(!i.ok)throw Error(i.error);(0,o.revalidatePath)("/admin"),(0,o.revalidatePath)("/guestbook")}async function T(e){let t=await (0,l.z)(),a=(0,i.randomUUID)(),s=e.get("filename"),r=e.get("fileurl"),c=e.get("filesize"),u=e.get("uploaded_at");if("admin"!==t.role)throw Error("Unauthorized");await n.k.insertInto("uploads").values({id:a,name:s,size:c,url:r,uploaded_at:u}).execute(),(0,o.revalidatePath)("/upload")}async function D({ip:e,location:t,path:a}){let s=(0,i.randomUUID)();await n.k.insertInto("visitors").values({id:s,url:a,ip:e,location:t}).execute()}async function O(e){let t;let a=e.get("from")||"Kapil Chaudhary <hi@kapil.app>",s=e.get("to"),o=e.get("subject"),n=e.get("html"),i=e.get("fileurl")||null,r=e.get("filename")||null;t=r&&i?JSON.stringify({from:a,to:s,subject:o,html:n,fileurl:i,filename:r}):JSON.stringify({from:a,to:s,subject:o,html:n});try{let e=await (0,k.n0)({subject:o},{expiresIn:"60s"}),a=await fetch("https://api.kapil.app/api/sendEmail",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:t,cache:"no-store"}),s=await a.json();s.message&&(0,c.cookies)().set({name:"email-sent-toast-msg",value:s.message,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e.message)}}async function I(e,t){try{let e=h();(0,c.cookies)().set("state",e,{...b,expires:new Date(Date.now()+6e4)});let a=await (0,k.n0)({state:e},{expiresIn:"60s"}),s=m.parse({username:t.get("username"),password:t.get("password")}),o=await fetch(process.env.API_URL+"/api/user/login?"+`state=${e}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":a,"x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value},body:JSON.stringify(s)}),n=await o.json();if(n.ok){let t=o.headers.get("x-state"),a=(await k.sw(t))?.state,s=(await k.$X({token:n.token.access_token}))?.id;if(a===e){let e=function(){let e=Date.now().valueOf().toString(16);return"id_"+e+w(6)}(),t=await fetch(process.env.API_URL+"/api/session",{method:"POST",body:JSON.stringify({sessionid:e,usertype:"Credentials",id:s}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token.access_token}`,"x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value}});await t.json();let a=await (0,d.T)();await a.set(s,e,"EX",604800),await a.quit(),(0,c.cookies)().set({name:"sessionId",value:e,...b,expires:new Date(n.token.refresh_expiry)}),(0,c.cookies)().set({name:"accessToken",value:n.token.access_token,...b,expires:new Date(n.token.access_expiry)}),(0,c.cookies)().set({name:"refreshToken",value:n.token.refresh_token,...b,expires:new Date(n.token.refresh_expiry)}),(0,c.cookies)().set({name:"profileToken",value:n.token.profile_token,...b,expires:new Date(n.token.profile_expiry)}),(0,c.cookies)().set({name:"LoginCookie",value:"Success",...b,expires:new Date(Date.now()+1e4)}),(0,c.cookies)().delete("state")}return y("SUCCESS","Login successfully!")}return console.log(n),y("ERROR",n.error)}catch(e){return v(e)}}async function _(e,t){let a=f.parse({username:t.get("username")?.toString(),password:t.get("password")?.toString(),email:t.get("email")?.toString(),fullname:t.get("full_name")?.toString()}),s=h();(0,c.cookies)().set("state",s,{...b,expires:new Date(Date.now()+6e4)});let o=`https://ui-avatars.com/api/?background=random&name=${a.fullname}`;try{let e=await (0,k.n0)({state:s},{expiresIn:"60s"}),t=await fetch(process.env.API_URL+"/api/user/register?"+`state=${s}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":e,"x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value},body:JSON.stringify({...a,avatar:o,role:"user"})}),n=await t.json();(0,c.cookies)().set({name:"RegisterCookie",value:n.message||n.error||"Something went wrong!",...b,expires:new Date(Date.now()+1e4)})}catch(e){return v(e)}return y("SUCCESS","Registration successful!")}async function E({callback:e}){return(0,c.cookies)().delete("refreshToken"),(0,c.cookies)().delete("profileToken"),(0,c.cookies)().delete("accessToken"),(0,c.cookies)().delete("sessionId"),(0,c.cookies)().delete("state"),(0,c.cookies)().delete("csrfToken"),(0,u.redirect)(e||"/signin?success=succesfully logged out!"),y("SUCCESS","Logout successful!")}async function $(e){let t=e.get("oldPass")?.toString(),a=e.get("newPass")?.toString(),s=c.cookies()?.get("accessToken")?.value||"",o=(await k.$X({token:s}))?.id||"";try{let e=h();(0,c.cookies)().set("state",e,{httpOnly:!0,secure:!0,expires:new Date(Date.now()+6e4)});let n=await (0,k.n0)({state:e},{expiresIn:"60s"}),i=await fetch(process.env.API_URL+"/api/user/password/change"+`?state=${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,Accept:"application/json","x-state":n,"x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value},body:JSON.stringify({id:o,oldPassword:t,newPassword:a})}),r=await i.json();console.log(r),(0,c.cookies)().set({name:"ChangePassCookie",value:r.message||r.error||"Something went wrong!",...b,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e)}}async function C(e){let t=e.get("username")?.toString();try{let e=h();(0,c.cookies)().set("state",e,{...b,expires:new Date(Date.now()+6e4)});let a=await (0,k.n0)({state:e},{expiresIn:"60s"}),s=await fetch(process.env.API_URL+"/api/user/password/recovery"+`?state=${e}`,{method:"POST",headers:{"Content-Type":"application/json","x-state":a,"x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value},body:JSON.stringify({email:t})}),o=await s.json();(0,c.cookies)().set({name:"ForgotPassCookie",value:o.message||o.error||"Something went wrong!",httpOnly:!0,secure:!0,expires:new Date(Date.now()+1e4)})}catch(e){throw console.log(e),Error(e)}}async function z(e){let t=e.get("password")?.toString(),a=e.get("token")?.toString();try{let e=await fetch(process.env.API_URL+`/api/user/password/reset?token=${a}`,{method:"POST",headers:{"Content-Type":"application/json","x-user-agent":c.cookies().get("userAgent")?.value,"x-ipaddress":c.cookies().get("sessionIP")?.value,"x-location":c.cookies().get("sessionLocation")?.value},body:JSON.stringify({password:t})}),s=await e.json();(0,c.cookies)().set({name:"ResetPassCookie",value:s.message||s.error||"Something went wrong!",httpOnly:!0,secure:!0,expires:new Date(Date.now()+1e4)})}catch(e){throw Error(e)}}async function R(e){let t=e.get("callback")?.toString()||"/profile",a=e.get("link")?.toString()||"";if(!a)throw Error("Invalid Link");let s=c.cookies().get("userAgent")?.value||"",o=c.cookies().get("sessionIP")?.value||"",n=c.cookies().get("sessionLocation")?.value||"",i=h();try{(0,c.cookies)().set({name:"csrfToken",value:i,httpOnly:!0,secure:!0,sameSite:!0,expires:new Date(Date.now()+9e4)})}catch(e){throw Error(e)}let r=await (0,k.n0)({csrfToken:i,callBackUrl:t,userAgent:s,sessionIP:o,sessionLocation:n},{expiresIn:"60s"}),l=`${a}&state=${r}`;(0,u.redirect)(l)}async function A({token:e,sessionId:t,next:a}){e&&t||await E({callback:`/signin?error=invalid_token_or_session_id&callbackUrl=${a}`});let s=await (0,k.$X)({token:e}),o=c.cookies().get("csrfToken")?.value||"";s.csrfToken===o&&s.csrfToken&&o||await E({callback:`/signin?error=error_csrf_token&callbackUrl=${a}`});let n={id:s.id,oauth:s.oauth,oauth_id:s.oauth_id},i=await (0,k.YB)({payload:n,options:{expiresIn:"7d"}}),r=await (0,k.YB)({payload:n,options:{expiresIn:"7d"}}),l={username:s.username,email:s.email,full_name:s.name,avatar:s.avatar,role:s.oauth+"user",verified:"true",oauth:s.oauth,userid:s.id},d=await (0,k.n0)(l,{expiresIn:"7d"}),g={httpOnly:!0,secure:!0,sameSite:!0,expiresIn:60674e4};(0,c.cookies)().set({name:"accessToken",value:i,...g}),(0,c.cookies)().set({name:"refreshToken",value:r,...g}),(0,c.cookies)().set({name:"profileToken",value:d,...g}),(0,c.cookies)().set({name:"sessionId",value:t,...g}),(0,c.cookies)().delete("csrfToken"),(0,u.redirect)(a)}(0,x.h)([S,j,P,T,D,O,I,_,E,$,C,z,R,A]),(0,s.j)("a6dd94c9a5ee4e261e28e05bb5ec9f9fd212030d",S),(0,s.j)("7f1c634e496dd895dea4360bfcb9158f1df525e7",j),(0,s.j)("fcb5f23b294268d5e3519c39d7e93eea08dcdcc9",P),(0,s.j)("c32985692d7ea9b3172c844b20d509274c70b8da",T),(0,s.j)("70e8978391a906d6eea06d651a38ae32ad637af2",D),(0,s.j)("066c11b8cac3d53459fd0307a3b3cc47ced190a1",O),(0,s.j)("974b965e2f2ef6bef20f0297f5dbd1e717f12dbd",I),(0,s.j)("a7f4b3fb4d4625bcd3ded760593d943407b107c0",_),(0,s.j)("050ef9f29dc3971027a64713c2e31c4cdb093526",E),(0,s.j)("e30178d742d3d980882e44bab85fc6bec80de55d",$),(0,s.j)("caf39b3519f53738dbd77e195302de8d39014d5e",C),(0,s.j)("c2ff7206db9feb41c1f1c0b0aec74d177cb5a725",z),(0,s.j)("638b5c86cdc66022f2483d06195290321560aa51",R),(0,s.j)("1e0322ba455c4fa7df31cdd42ecfc9179872ae4b",A)}};